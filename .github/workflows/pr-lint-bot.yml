name: Trigger lint format
on:
  workflow_call:
    secrets:
      IVY_BRANCH_TOKEN:
        required: true
        description: "Token to access ivy-branch account"

permissions:
  contents: write

jobs:
  trigger:
    runs-on: ubuntu-latest
    name: Check for triggers
    if: ${{ github.event.issue.pull_request }}
    outputs:
      ivy-gardener: ${{ steps.ivy-gardener.outputs.triggered }}
      head-ref: ${{ steps.comment-branch.outputs.head_ref }}
      head-repo: ${{ steps.comment-branch.outputs.head_owner }}/${{ steps.comment-branch.outputs.head_repo }}
    steps:
      - uses: khan/pull-request-comment-trigger@v1.1.0
        id: ivy-gardener
        name: Check for ivy-lint
        with:
          trigger: 'ivy-gardener'
          reaction: rocket
        env:
          GITHUB_TOKEN: '${{ secrets.IVY_BRANCH_TOKEN }}'
      
      - uses: KareemMAX/pull-request-comment-branch@head-repo-owner-release
        id: comment-branch

  format-code:
    needs: trigger
    if: ${{ needs.trigger.outputs.ivy-gardener == 'true' }}
    name: Trigger lint bot
    uses: ./.github/workflows/lint-bot.yml
    secrets: inherit
    with:
      head-ref: ${{ needs.trigger.outputs.head-ref }}
      head-repo: ${{ needs.trigger.outputs.head-repo }}

  acknowledge-format:
    runs-on: ubuntu-latest
    needs: format-code
    name: Acknowledge lint bot
    steps:
      - name: Acknowledge lint bot
        uses: peter-evans/create-or-update-comment@v3
        with:
          comment-id: ${{ github.event.comment.id }}
          body: |
            :white_check_mark: Ivy gardener has formatted your code.
          reactions: '+1'
          token: ${{ secrets.IVY_BRANCH_TOKEN }}
